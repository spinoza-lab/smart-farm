#!/usr/bin/env python3
"""
sensor_reader.py
ì„¼ì„œ ë°ì´í„° ì½ê¸° í´ë˜ìŠ¤ (ADS1115 ADC) - ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì§€ì›
"""

import board
import busio
import adafruit_ads1x15.ads1115 as ADS
from adafruit_ads1x15.analog_in import AnalogIn
import time
import json
import os


class SensorReader:
    """ADS1115 ADCë¥¼ í†µí•œ ì„¼ì„œ ë°ì´í„° ì½ê¸°"""
    
    # ì„¼ì„œ ë§¤í•‘
    SENSOR_MAP = {
        'water_level_1': 0,  # A0: ë¬¼íƒ±í¬ 1 ìˆ˜ìœ„ì„¼ì„œ
        'water_level_2': 1,  # A1: ì–‘ì•¡íƒ±í¬ 2 ìˆ˜ìœ„ì„¼ì„œ
        'spare_1': 2,        # A2: ì˜ˆë¹„
        'spare_2': 3,        # A3: ì˜ˆë¹„
    }
    
    def __init__(self, address=0x48):
        """
        ì´ˆê¸°í™”
        
        Args:
            address: I2C ì£¼ì†Œ (ê¸°ë³¸ 0x48)
        """
        print(f"ğŸ”§ SensorReader ì´ˆê¸°í™” (ì£¼ì†Œ: 0x{address:02X})")
        
        self.address = address
        self.i2c = busio.I2C(board.SCL, board.SDA)
        self.ads = ADS.ADS1115(self.i2c, address=address)
        
        # ì±„ë„ ê°ì²´ ìƒì„±
        self.channels = {
            0: AnalogIn(self.ads, ADS.P0),
            1: AnalogIn(self.ads, ADS.P1),
            2: AnalogIn(self.ads, ADS.P2),
            3: AnalogIn(self.ads, ADS.P3),
        }
        
        # ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œë“œ
        self.calibration = self._load_calibration()
        
        print(f"âœ… SensorReader ì´ˆê¸°í™” ì™„ë£Œ")
        print(f"   ì„¼ì„œ íƒ€ì…: {self.calibration.get('sensor_type', 'voltage')}")
    
    def _load_calibration(self):
        """ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒŒì¼ ë¡œë“œ"""
        config_path = os.path.join(
            os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
            'config',
            'sensor_calibration.json'
        )
        
        try:
            if os.path.exists(config_path):
                with open(config_path, 'r', encoding='utf-8') as f:
                    calibration = json.load(f)
                print(f"ğŸ“‹ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œë“œ ì™„ë£Œ: {config_path}")
                return calibration
            else:
                print(f"âš ï¸  ìº˜ë¦¬ë¸Œë ˆì´ì…˜ íŒŒì¼ ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©")
                return self._get_default_calibration()
        except Exception as e:
            print(f"âš ï¸  ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œë“œ ì‹¤íŒ¨: {e}, ê¸°ë³¸ê°’ ì‚¬ìš©")
            return self._get_default_calibration()
    
    def _get_default_calibration(self):
        """ê¸°ë³¸ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê°’"""
        return {
            'sensor_type': 'voltage',
            'tank1_water': {
                'empty_value': 0.5,
                'full_value': 4.5
            },
            'tank2_nutrient': {
                'empty_value': 0.5,
                'full_value': 4.5
            }
        }
    
    def reload_calibration(self):
        """ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì¬ë¡œë“œ (ì„¤ì • ë³€ê²½ í›„ í˜¸ì¶œ)"""
        print("ğŸ”„ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì¬ë¡œë“œ ì¤‘...")
        self.calibration = self._load_calibration()
        print("âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì¬ë¡œë“œ ì™„ë£Œ")
    
    def read_voltage(self, channel):
        """
        ì „ì•• ì½ê¸°
        
        Args:
            channel: ì±„ë„ ë²ˆí˜¸ (0-3)
            
        Returns:
            float: ì „ì•• (V)
        """
        if channel not in self.channels:
            print(f"âŒ ì˜ëª»ëœ ì±„ë„: {channel}")
            return None
        
        return self.channels[channel].voltage
    
    def read_raw(self, channel):
        """
        RAW ê°’ ì½ê¸°
        
        Args:
            channel: ì±„ë„ ë²ˆí˜¸ (0-3)
            
        Returns:
            int: RAW ê°’
        """
        if channel not in self.channels:
            print(f"âŒ ì˜ëª»ëœ ì±„ë„: {channel}")
            return None
        
        return self.channels[channel].value
    
    def read_sensor(self, sensor_name):
        """
        ì„¼ì„œ ì´ë¦„ìœ¼ë¡œ ì „ì•• ì½ê¸°
        
        Args:
            sensor_name: ì„¼ì„œ ì´ë¦„ ('water_level_1', 'water_level_2', ...)
            
        Returns:
            float: ì „ì•• (V)
        """
        if sensor_name not in self.SENSOR_MAP:
            print(f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì„¼ì„œ: {sensor_name}")
            return None
        
        channel = self.SENSOR_MAP[sensor_name]
        return self.read_voltage(channel)
    
    def _voltage_to_percent(self, voltage, empty_value, full_value):
        """
        ì „ì•• â†’ í¼ì„¼íŠ¸ ë³€í™˜ (ì„ í˜• ë³´ê°„)
        
        Args:
            voltage: í˜„ì¬ ì „ì•• (V)
            empty_value: ê³µíƒ±í¬ ì „ì•• (V)
            full_value: ë§Œìˆ˜ ì „ì•• (V)
            
        Returns:
            float: ìˆ˜ìœ„ í¼ì„¼íŠ¸ (0-100%)
        """
        if full_value == empty_value:
            return 0.0
        
        percent = ((voltage - empty_value) / (full_value - empty_value)) * 100.0
        percent = max(0, min(100, percent))  # 0-100 ë²”ìœ„ë¡œ ì œí•œ
        
        return percent
    

    def read_water_level(self, tank_num):
        """
        ë¬¼íƒ±í¬ ìˆ˜ìœ„ ì½ê¸° (ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì ìš©)
        
        Args:
            tank_num: íƒ±í¬ ë²ˆí˜¸ (1 ë˜ëŠ” 2)
            
        Returns:
            float: ìˆ˜ìœ„ í¼ì„¼íŠ¸ (0-100%)
        """
        if tank_num == 1:
            voltage = self.read_sensor('water_level_1')
            tank_key = 'tank1_water'
        elif tank_num == 2:
            voltage = self.read_sensor('water_level_2')
            tank_key = 'tank2_nutrient'
        else:
            print(f"âŒ ì˜ëª»ëœ íƒ±í¬ ë²ˆí˜¸: {tank_num}")
            return None
        
        if voltage is None:
            return None
        
        # ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        tank_cal = self.calibration.get(tank_key, {})
        empty_value = tank_cal.get('empty_value', 0.5)
        full_value = tank_cal.get('full_value', 4.5)
        
        sensor_type = self.calibration.get('sensor_type', 'voltage')
        
        # ì „ì•• ì„¼ì„œ (0-5V)
            percent = self._voltage_to_percent(voltage, empty_value, full_value)
        
        return percent
    
    def read_all_channels(self):
        """
        ëª¨ë“  ì±„ë„ ì½ê¸°
        
        Returns:
            dict: {ì±„ë„: ì „ì••}
        """
        result = {}
        for channel in range(4):
            result[channel] = self.read_voltage(channel)
        return result
    
    def monitor(self, interval=2, duration=10):
        """
        ì„¼ì„œ ëª¨ë‹ˆí„°ë§
        
        Args:
            interval: ì½ê¸° ê°„ê²© (ì´ˆ)
            duration: ëª¨ë‹ˆí„°ë§ ì‹œê°„ (ì´ˆ)
        """
        print("\n" + "="*60)
        print(f"ğŸ“Š ì„¼ì„œ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ê°„ê²©: {interval}ì´ˆ, ì§€ì†: {duration}ì´ˆ)")
        print("="*60)
        
        start_time = time.time()
        
        try:
            while time.time() - start_time < duration:
                print(f"\nâ° {time.strftime('%H:%M:%S')}")
                
                # ëª¨ë“  ì±„ë„ ì½ê¸°
                for channel in range(4):
                    voltage = self.read_voltage(channel)
                    raw = self.read_raw(channel)
                    print(f"   ì±„ë„ {channel}: {voltage:.3f}V (RAW: {raw})")
                
                # ë¬¼íƒ±í¬ ìˆ˜ìœ„
                for tank in [1, 2]:
                    level = self.read_water_level(tank)
                    if level is not None:
                        print(f"   ğŸ’§ íƒ±í¬ {tank} ìˆ˜ìœ„: {level:.1f}%")
                
                time.sleep(interval)
        
        except KeyboardInterrupt:
            print("\nâš ï¸  ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨")
        
        print("\n" + "="*60)
        print("âœ… ëª¨ë‹ˆí„°ë§ ì¢…ë£Œ")
        print("="*60)
    
    def calibrate_sensor(self, sensor_name, samples=10):
        """
        ì„¼ì„œ ìº˜ë¦¬ë¸Œë ˆì´ì…˜
        
        Args:
            sensor_name: ì„¼ì„œ ì´ë¦„
            samples: ìƒ˜í”Œ ê°œìˆ˜
            
        Returns:
            dict: {'min': ìµœì†Œê°’, 'max': ìµœëŒ€ê°’, 'avg': í‰ê· ê°’}
        """
        print(f"\nğŸ”§ {sensor_name} ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ({samples}íšŒ ì¸¡ì •)")
        
        values = []
        for i in range(samples):
            voltage = self.read_sensor(sensor_name)
            if voltage is not None:
                values.append(voltage)
                print(f"   [{i+1}/{samples}] {voltage:.3f}V")
            time.sleep(0.1)
        
        if not values:
            print("âŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì‹¤íŒ¨")
            return None
        
        result = {
            'min': min(values),
            'max': max(values),
            'avg': sum(values) / len(values)
        }
        
        print(f"\nğŸ“Š ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê²°ê³¼:")
        print(f"   ìµœì†Œ: {result['min']:.3f}V")
        print(f"   ìµœëŒ€: {result['max']:.3f}V")
        print(f"   í‰ê· : {result['avg']:.3f}V")
        
        return result


# í…ŒìŠ¤íŠ¸ ì½”ë“œ
if __name__ == "__main__":
    print("="*60)
    print("ğŸ§ª SensorReader í…ŒìŠ¤íŠ¸ (ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì§€ì›)")
    print("="*60)
    
    try:
        # ì„¼ì„œ ë¦¬ë” ì´ˆê¸°í™”
        sensor = SensorReader(address=0x48)
        
        # í…ŒìŠ¤íŠ¸ 1: ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì •ë³´ ì¶œë ¥
        print("\n[í…ŒìŠ¤íŠ¸ 1] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì •ë³´")
        print(f"   ì„¼ì„œ íƒ€ì…: {sensor.calibration.get('sensor_type')}")
        print(f"   íƒ±í¬1 ê³µíƒ±í¬: {sensor.calibration['tank1_water']['empty_value']}V")
        print(f"   íƒ±í¬1 ë§Œìˆ˜: {sensor.calibration['tank1_water']['full_value']}V")
        print(f"   íƒ±í¬2 ê³µíƒ±í¬: {sensor.calibration['tank2_nutrient']['empty_value']}V")
        print(f"   íƒ±í¬2 ë§Œìˆ˜: {sensor.calibration['tank2_nutrient']['full_value']}V")
        
        # í…ŒìŠ¤íŠ¸ 2: ë‹¨ì¼ ì±„ë„ ì½ê¸°
        print("\n[í…ŒìŠ¤íŠ¸ 2] ì±„ë„ 0 ì½ê¸°")
        voltage = sensor.read_voltage(0)
        raw = sensor.read_raw(0)
        print(f"   ì „ì••: {voltage:.3f}V")
        print(f"   RAW: {raw}")
        
        # í…ŒìŠ¤íŠ¸ 3: ë¬¼íƒ±í¬ ìˆ˜ìœ„ ì½ê¸° (ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì ìš©)
        print("\n[í…ŒìŠ¤íŠ¸ 3] ë¬¼íƒ±í¬ ìˆ˜ìœ„ (ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì ìš©)")
        for tank in [1, 2]:
            level = sensor.read_water_level(tank)
            if level is not None:
                print(f"   íƒ±í¬ {tank}: {level:.1f}%")
        
        # í…ŒìŠ¤íŠ¸ 4: ëª¨ë“  ì±„ë„ ì½ê¸°
        print("\n[í…ŒìŠ¤íŠ¸ 4] ëª¨ë“  ì±„ë„ ì½ê¸°")
        all_data = sensor.read_all_channels()
        for channel, voltage in all_data.items():
            print(f"   ì±„ë„ {channel}: {voltage:.3f}V")
        
        # í…ŒìŠ¤íŠ¸ 5: ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì¬ë¡œë“œ
        print("\n[í…ŒìŠ¤íŠ¸ 5] ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì¬ë¡œë“œ")
        sensor.reload_calibration()
        
        print("\n" + "="*60)
        print("âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
        print("="*60)
        
    except Exception as e:
        print(f"\nâŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
        import traceback
        traceback.print_exc()
