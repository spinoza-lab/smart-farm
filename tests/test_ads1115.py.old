#!/usr/bin/env python3
"""
test_ads1115.py
ADS1115 ADC(ì•„ë‚ ë¡œê·¸-ë””ì§€í„¸ ë³€í™˜ê¸°) í…ŒìŠ¤íŠ¸
ê°€ë³€ì €í•­ ë˜ëŠ” ì„¼ì„œë¥¼ ì—°ê²°í•˜ì—¬ ì „ì•• ì¸¡ì •
"""

import board
import busio
import adafruit_ads1x15.ads1115 as ADS
from adafruit_ads1x15.analog_in import AnalogIn
import time

def test_ads1115(address=0x48, channel=0, duration=10):
    """
    ADS1115 í…ŒìŠ¤íŠ¸
    
    Args:
        address: I2C ì£¼ì†Œ (ê¸°ë³¸ 0x48)
        channel: ì¸¡ì •í•  ì±„ë„ (0-3)
        duration: ì¸¡ì • ì‹œê°„ (ì´ˆ)
    """
    print("=" * 50)
    print("ğŸ§ª ADS1115 ADC í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    print()
    
    try:
        # I2C ì´ˆê¸°í™”
        print("1ï¸âƒ£ I2C ì´ˆê¸°í™” ì¤‘...")
        i2c = busio.I2C(board.SCL, board.SDA)
        print("   âœ“ I2C ì´ˆê¸°í™” ì„±ê³µ")
        print()
        
        # ADS1115 ì—°ê²°
        print(f"2ï¸âƒ£ ADS1115 ì—°ê²° ì¤‘... (ì£¼ì†Œ: 0x{address:02X})")
        ads = ADS.ADS1115(i2c, address=address)
        print(f"   âœ“ ADS1115 (0x{address:02X}) ì—°ê²° ì„±ê³µ")
        print()
        
        # ì±„ë„ ì„¤ì •
        print(f"3ï¸âƒ£ ì±„ë„ {channel} ì„¤ì • ì¤‘...")
        
        if channel == 0:
            chan = AnalogIn(ads, ADS.P0)
        elif channel == 1:
            chan = AnalogIn(ads, ADS.P1)
        elif channel == 2:
            chan = AnalogIn(ads, ADS.P2)
        elif channel == 3:
            chan = AnalogIn(ads, ADS.P3)
        else:
            print(f"   âŒ ì˜ëª»ëœ ì±„ë„ ë²ˆí˜¸: {channel} (0-3 ì‚¬ìš© ê°€ëŠ¥)")
            return False
        
        print(f"   âœ“ ì±„ë„ {channel} ì„¤ì • ì™„ë£Œ")
        print()
        
        # ì „ì•• ì¸¡ì •
        print(f"4ï¸âƒ£ ì „ì•• ì¸¡ì • ({duration}ì´ˆ)")
        print()
        print("   í…ŒìŠ¤íŠ¸ ë°©ë²•:")
        print(f"   - A{channel}ì— ê°€ë³€ì €í•­ ì¤‘ê°„ ë‹¨ìë¥¼ ì—°ê²°í•˜ì„¸ìš”")
        print("   - ê°€ë³€ì €í•­ ì–‘ ëì€ VDD(3.3V)ì™€ GNDì— ì—°ê²°")
        print("   - ê°€ë³€ì €í•­ì„ ëŒë¦¬ë©´ì„œ ì „ì•• ë³€í™”ë¥¼ í™•ì¸í•˜ì„¸ìš”")
        print()
        print("   ğŸ“Š ì¸¡ì • ì‹œì‘...")
        print("   " + "-" * 45)
        
        for i in range(duration):
            voltage = chan.voltage
            value = chan.value
            
            # í”„ë¡œê·¸ë ˆìŠ¤ ë°”
            bar_length = 30
            bar_filled = int((voltage / 3.3) * bar_length)
            bar = "â–ˆ" * bar_filled + "â–‘" * (bar_length - bar_filled)
            
            print(f"   [{i+1:2d}/{duration:2d}] {voltage:.3f}V |{bar}| ({value:5d})")
            time.sleep(1)
        
        print("   " + "-" * 45)
        print()
        print("=" * 50)
        print("âœ… ADS1115 í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
        print("=" * 50)
        print()
        print("ğŸ’¡ 4-20mA ì„¼ì„œ ì—°ê²° ì‹œ:")
        print("   ì„¼ì„œ+ â†’ 24V")
        print("   ì„¼ì„œ- â†’ 250Î© â†’ GND")
        print(f"   250Î© ì¤‘ê°„ â†’ A{channel}")
        print("   4mA = 1.0V, 20mA = 5.0V")
        return True
        
    except ValueError as e:
        print()
        print("âŒ ADS1115ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
        print()
        print("ğŸ” ë¬¸ì œ í•´ê²° ë°©ë²•:")
        print(f"   1. i2cdetect -y 1 ì„ ì‹¤í–‰í•˜ì—¬ 0x{address:02X} ì£¼ì†Œ í™•ì¸")
        print("   2. ë°°ì„  í™•ì¸:")
        print("      - VDD â†’ 3.3V (Pin 1)")
        print("      - GND â†’ GND (Pin 6)")
        print("      - SDA â†’ GPIO 2 (Pin 3)")
        print("      - SCL â†’ GPIO 3 (Pin 5)")
        print("      - ADDR â†’ GND (ì£¼ì†Œ 0x48ë¡œ ì„¤ì •)")
        return False
        
    except Exception as e:
        print()
        print(f"âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
        print()
        print("ğŸ” ë¬¸ì œ í•´ê²°:")
        print("   1. I2Cê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸")
        print("   2. ì „ì•• ë²”ìœ„ í™•ì¸ (0-3.3V ë˜ëŠ” 0-5V)")
        print("   3. ì±„ë„ ë²ˆí˜¸ í™•ì¸ (0-3)")
        return False

if __name__ == '__main__':
    # ê¸°ë³¸ í…ŒìŠ¤íŠ¸ (0x48, ì±„ë„ 0, 10ì´ˆ)
    test_ads1115(address=0x48, channel=0, duration=10)
    
    # ë‹¤ë¥¸ ì±„ë„ í…ŒìŠ¤íŠ¸ (ì£¼ì„ í•´ì œí•˜ì—¬ ì‚¬ìš©)
    # test_ads1115(address=0x48, channel=1, duration=10)
    # test_ads1115(address=0x48, channel=2, duration=10)
    # test_ads1115(address=0x48, channel=3, duration=10)
